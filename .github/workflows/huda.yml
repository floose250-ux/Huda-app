name: HUDA-PRO-V73-PROTECT
on: [push, workflow_dispatch]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      
      - run: |
          # حذفنا أمر مسح الـ assets لنحمي شغلك اليدوي
          rm -rf lib android ios pubspec.yaml
          flutter create . --org com.huda.app.official --project-name huda_pro --overwrite
          mkdir -p lib/screens
          
          # إنشاء الأكواد فقط دون المساس ببيانات القرآن
          cat <<'EOF' > lib/main.dart
          import 'package:flutter/material.dart';
          import 'screens/quran.dart';
          void main() => runApp(const MaterialApp(home: QuranPage(), debugShowCheckedModeBanner: false));
          EOF

          cat <<'EOF' > lib/screens/quran.dart
          import 'package:flutter/material.dart';
          import 'dart:convert';
          import 'package:flutter/services.dart';

          class QuranPage extends StatefulWidget {
            const QuranPage({super.key});
            @override _QuranPageState createState() => _QuranPageState();
          }

          class _QuranPageState extends State<QuranPage> {
            List surahs = [];
            Future<void> loadData() async {
              final String res = await rootBundle.loadString('assets/quran.json');
              final data = json.decode(res);
              setState(() => surahs = data['surahs']);
            }
            @override void initState() { super.initState(); loadData(); }

            @override
            Widget build(BuildContext context) => Scaffold(
              backgroundColor: const Color(0xFF000D0D),
              appBar: AppBar(title: const Text('المصحف الشريف'), backgroundColor: const Color(0xFF001F1F)),
              body: surahs.isEmpty ? const Center(child: CircularProgressIndicator()) : ListView.builder(
                itemCount: surahs.length,
                itemBuilder: (c, i) => ListTile(
                  leading: CircleAvatar(child: Text('${i+1}')),
                  title: Text(surahs[i]['name'], style: const TextStyle(color: Colors.white)),
                ),
              ),
            );
          }
          EOF

          # تحديث pubspec ليعرف مكان ملفك اليدوي
          cat <<'EOF' > pubspec.yaml
          name: huda_pro
          environment: {sdk: ">=3.0.0 <4.0.0"}
          dependencies: {flutter: {sdk: flutter}}
          flutter: {uses-material-design: true, assets: [assets/quran.json]}
          EOF

      - run: flutter pub get
      - run: flutter build apk --release
      
      - uses: actions/upload-artifact@v4
        with:
          name: HUDA-PRO-APK-V73
          path: build/app/outputs/flutter-apk/app-release.apk
