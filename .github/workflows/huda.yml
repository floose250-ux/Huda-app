name: HUDA-ULTIMATE-V64
on: [push, workflow_dispatch]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      
      # 1. تنظيف وإصلاح شامل للنظام لضمان عمل الـ APK
      - run: |
          rm -rf lib android ios assets pubspec.yaml
          flutter create . --org com.huda.app.ultimate --project-name huda_pro --overwrite
      
      # 2. بناء "الغرف" (الملفات المنفصلة) وحقن كل المميزات القديمة والجديدة
      - run: |
          mkdir -p lib/screens
          mkdir -p assets

          # --- أ: ملف المحرك الرئيسي (الرئيسية والتنقل) ---
          cat <<'EOF' > lib/main.dart
          import 'package:flutter/material.dart';
          import 'screens/quran.dart';
          import 'screens/lineage.dart';
          import 'screens/haram.dart';
          import 'screens/kids.dart';

          void main() => runApp(const MaterialApp(home: MainNav(), debugShowCheckedModeBanner: false));

          class MainNav extends StatefulWidget {
            const MainNav({super.key});
            @override _MainNavState createState() => _MainNavState();
          }

          class _MainNavState extends State<MainNav> {
            int _idx = 0;
            final List<Widget> _screens = [const HomeScreen(), const QuranPage(), const LineagePage(), const HaramPage(), const KidsPage()];
            @override
            Widget build(BuildContext context) => Scaffold(
              body: _screens[_idx],
              bottomNavigationBar: BottomNavigationBar(
                currentIndex: _idx,
                onTap: (i) => setState(() => _idx = i),
                type: BottomNavigationBarType.fixed,
                backgroundColor: const Color(0xFF001F1F),
                selectedItemColor: Colors.amber,
                unselectedItemColor: Colors.white60,
                items: const [
                  BottomNavigationBarItem(icon: Icon(Icons.home), label: 'الرئيسية'),
                  BottomNavigationBarItem(icon: Icon(Icons.menu_book), label: 'المصحف'),
                  BottomNavigationBarItem(icon: Icon(Icons.people), label: 'الأنساب'),
                  BottomNavigationBarItem(icon: Icon(Icons.warning), label: 'تنبيهات'),
                  BottomNavigationBarItem(icon: Icon(Icons.child_care), label: 'البراعم'),
                ],
              ),
            );
          }
          class HomeScreen extends StatelessWidget {
            const HomeScreen({super.key});
            @override
            Widget build(BuildContext context) => const Scaffold(backgroundColor: Color(0xFF000D0D), body: Center(child: Icon(Icons.mosque, size: 80, color: Colors.teal)));
          }
          EOF

          # --- ب: ملف المصحف الشامل (الفاتحة + الـ 114 سورة) ---
          cat <<'EOF' > lib/screens/quran.dart
          import 'package:flutter/material.dart';
          class QuranPage extends StatelessWidget {
            const QuranPage({super.key});
            final List<String> surahs = const ['الفاتحة', 'البقرة', 'آل عمران', 'النساء', 'المائدة', 'الأنعام', 'الأعراف', 'الأنفال', 'التوبة', 'يونس', 'هود', 'يوسف', 'الرعد', 'إبراهيم', 'الحجر', 'النحل', 'الإسراء', 'الكهف', 'مريم', 'طه', 'الأنبياء', 'الحج', 'المؤمنون', 'النور', 'الفرقان', 'الشعراء', 'النمل', 'القصص', 'العنكبوت', 'الروم', 'لقمان', 'السجدة', 'الأحزاب', 'سبأ', 'فاطر', 'يس', 'الصافات', 'ص', 'الزمر', 'غافر', 'فصلت', 'الشورى', 'الزخرف', 'الدخان', 'الجاثية', 'الأحقاف', 'محمد', 'الفتح', 'الحجرات', 'ق', 'الذاريات', 'الطور', 'النجم', 'القمر', 'الرحمن', 'الواقعة', 'الحديد', 'المجادلة', 'الحشر', 'الممتحنة', 'الصف', 'الجمعة', 'المنافقون', 'التغابن', 'الطلاق', 'التحريم', 'الملك', 'القلم', 'الحاقة', 'المعارج', 'نوح', 'الجن', 'المزمل', 'المدثر', 'القيامة', 'الإنسان', 'المرسلات', 'النبأ', 'النازعات', 'عبس', 'التكوير', 'الانفطار', 'المطففين', 'الانشقاق', 'البروج', 'الطارق', 'الأعلى', 'الغاشية', 'الفجر', 'البلد', 'الشمس', 'الليل', 'الضحى', 'الشرح', 'التين', 'العلق', 'القدر', 'البينة', 'الزلزلة', 'العاديات', 'القارعة', 'التكاثر', 'العصر', 'الهمزة', 'الفيل', 'قريش', 'الماعون', 'الكوثر', 'الكافرون', 'النصر', 'المسد', 'الإخلاص', 'الفلق', 'الناس'];
            @override
            Widget build(BuildContext context) => Scaffold(
              backgroundColor: const Color(0xFF000D0D),
              appBar: AppBar(title: const Text('المصحف الشريف'), backgroundColor: const Color(0xFF001F1F)),
              body: ListView.builder(
                itemCount: surahs.length,
                itemBuilder: (c, i) => ListTile(
                  leading: CircleAvatar(child: Text('${i+1}')),
                  title: Text(surahs[i], style: const TextStyle(color: Colors.white)),
                ),
              ),
            );
          }
          EOF

          # --- ج: ملف الأنساب (العوالق وبني حارث والصحابة) ---
          cat <<'EOF' > lib/screens/lineage.dart
          import 'package:flutter/material.dart';
          class LineagePage extends StatelessWidget {
            const LineagePage({super.key});
            @override
            Widget build(BuildContext context) => Scaffold(
              backgroundColor: const Color(0xFF000D0D),
              appBar: AppBar(title: const Text('الأنساب والقبائل')),
              body: ListView(children: const [
                ListTile(title: Text('قبيلة العوالق', style: TextStyle(color: Colors.amber))),
                ListTile(title: Text('بني حارث', style: TextStyle(color: Colors.amber))),
                ListTile(title: Text('أبو بكر الصديق (بنو تيم)', style: TextStyle(color: Colors.white))),
              ]),
            );
          }
          EOF

          # --- د: ملف المحرمات (الإسبال والنميمة) ---
          cat <<'EOF' > lib/screens/haram.dart
          import 'package:flutter/material.dart';
          class HaramPage extends StatelessWidget {
            const HaramPage({super.key});
            @override
            Widget build(BuildContext context) => Scaffold(
              backgroundColor: const Color(0xFF000D0D),
              appBar: AppBar(title: const Text('المحرمات الموثقة')),
              body: ListView(children: const [
                ExpansionTile(title: Text('الإسبال للرجال', style: TextStyle(color: Colors.redAccent)), children: [Padding(padding: EdgeInsets.all(15), child: Text('قال ﷺ: ما أسفل من الكعبين من الإزار ففي النار (رواه البخاري)'))]),
                ExpansionTile(title: Text('النميمة', style: TextStyle(color: Colors.redAccent)), children: [Padding(padding: EdgeInsets.all(15), child: Text('قال ﷺ: لا يدخل الجنة نمام (متفق عليه)'))]),
              ]),
            );
          }
          EOF

          # --- هـ: ملف براعم الإيمان (ركن الأطفال) ---
          cat <<'EOF' > lib/screens/kids.dart
          import 'package:flutter/material.dart';
          class KidsPage extends StatelessWidget {
            const KidsPage({super.key});
            @override
            Widget build(BuildContext context) => Scaffold(
              backgroundColor: const Color(0xFF1A001A),
              appBar: AppBar(title: const Text('براعم الإيمان'), backgroundColor: Colors.purple),
              body: const Center(child: Text('قصص الأنبياء وأخلاق المسلم الصغير', style: TextStyle(color: Colors.white70))),
            );
          }
          EOF

      - run: flutter pub get
      - run: flutter build apk --release
      
      - uses: actions/upload-artifact@v4
        with:
          name: HUDA-COMPLETE-FIXED-V64
          path: build/app/outputs/flutter-apk/app-release.apk
